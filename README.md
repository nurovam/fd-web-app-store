# FamilyDent Storefront

Full-stack storefront for dental supplies: Django REST API, React (Vite) SPA, NGINX gateway, Postgres, and a Telegram bot for order operations. The stack is Docker-first but also supports local development.

## Stack
- Backend: Django + DRF
- Frontend: React (Vite)
- Web gateway: NGINX (serves SPA + proxies `/api/`)
- Database: Postgres
- Bot: Telegram order bot (optional)

## Features
- Cookie-based JWT auth with CSRF protection
- Catalog with search, filters, and pagination
- Cart and order management
- Staff service portal for catalog/order actions
- Consultation requests stored in DB + Telegram notifications
- PDF price list download
- Telegram bot: orders, consultations, stats, PDF report
- Media uploads and async image resizing

## Project Structure
- `backend/` Django project (`backend/`) and `store` app
- `frontend/` React SPA
- `nginx/` NGINX config + Dockerfile
- `docker-compose.yml` service orchestration

## Quick Start (Docker)
```bash
cp backend/.env.example backend/.env
docker compose up --build
```
Open:
- Web UI: `http://localhost:8080`
- API docs: `http://localhost:8080/api/docs/` (requires `DJANGO_ENABLE_API_DOCS=1`)

## Environment Configuration
`backend/.env` is not committed. Start from `backend/.env.example` and adjust:
- `DJANGO_SECRET_KEY`, `DJANGO_DEBUG`, `DJANGO_ALLOWED_HOSTS`
- `CORS_ALLOWED_ORIGINS`, `CSRF_TRUSTED_ORIGINS`
- `DJANGO_SECURE_SSL_REDIRECT`, `DJANGO_SESSION_COOKIE_SECURE`, `DJANGO_CSRF_COOKIE_SECURE`
- `DJANGO_AUTH_COOKIE_SECURE`, `DJANGO_AUTH_COOKIE_SAMESITE`, `DJANGO_AUTH_COOKIE_DOMAIN`
- `DB_NAME`, `DB_USER`, `DB_PASSWORD`, `DB_HOST`, `DB_PORT`
- `SERVICE_ACCOUNT_USERNAME`, `SERVICE_ACCOUNT_PASSWORD`, `SERVICE_ACCOUNT_EMAIL`
- `TELEGRAM_BOT_TOKEN`, `TELEGRAM_CHAT_ID` or `TELEGRAM_ADMIN_CHAT_IDS`
- `DJANGO_AUTH_THROTTLE_RATE`, `DJANGO_CONTACT_THROTTLE_RATE`
- `DJANGO_API_CACHE_TTL`, `DJANGO_PRICE_LIST_CACHE_TTL`
- `DJANGO_PRICE_LIST_FONT_PATH` (for Cyrillic PDF fonts)

## Auth Flow (Cookie JWT)
1. `GET /api/auth/csrf/` to set CSRF cookie.
2. `POST /api/auth/token/` to login (cookies only).
3. `POST /api/auth/token/refresh/` to refresh (uses refresh cookie).
4. `POST /api/auth/logout/` to clear cookies.

The frontend axios client is configured for `withCredentials` and CSRF headers.

## Local Development (no Docker)
Backend:
```bash
cd backend
python -m venv .venv
. .venv/bin/activate
pip install -r requirements.txt
python manage.py migrate
python manage.py createserviceaccount
python manage.py runserver
```

Frontend:
```bash
cd frontend
npm install
npm run dev
```
Open `http://localhost:5173`. The Vite dev server proxies `/api` to `http://localhost:8000`.

## Telegram Bot
The bot runs as `python manage.py order_bot` (or Docker `bot` service). It supports:
- Orders list + status updates
- Consultations list + close action
- Stats summary
- PDF report download with selected period

Required env:
- `TELEGRAM_BOT_TOKEN`
- `TELEGRAM_CHAT_ID` or `TELEGRAM_ADMIN_CHAT_IDS`

## PDF Downloads
- Price list: `GET /api/catalog/pricelist/`
- Orders report: generated by the Telegram bot (PDF)

## Core API Endpoints
- `POST /api/auth/register/`
- `POST /api/auth/token/`
- `POST /api/auth/token/refresh/`
- `POST /api/auth/logout/`
- `GET /api/account/me/`
- `GET /api/account/profile/`
- `POST /api/consultation/`
- `GET /api/catalog/categories/`
- `GET /api/catalog/products/`
- `GET /api/catalog/pricelist/`
- `GET /api/cart/`
- `POST /api/orders/`
- `POST /api/orders/{id}/pay/` (staff/manager)

## Production Notes
- Set `DJANGO_DEBUG=0` and explicit `DJANGO_ALLOWED_HOSTS`.
- Use HTTPS and set:
  - `DJANGO_SECURE_SSL_REDIRECT=1`
  - `DJANGO_SESSION_COOKIE_SECURE=1`
  - `DJANGO_CSRF_COOKIE_SECURE=1`
  - `DJANGO_AUTH_COOKIE_SECURE=1`
  - `DJANGO_SECURE_PROXY_SSL_HEADER=HTTP_X_FORWARDED_PROTO,https`
- Disable public docs/health in prod (`DJANGO_ENABLE_API_DOCS=0`, `DJANGO_HEALTHCHECK_PUBLIC=0`).

## Troubleshooting
- `backend/.env not found`: copy from `.env.example`.
- Docker build fails to pull base images: check DNS/network access to Docker Hub.
- Login fails on a new host: add it to `DJANGO_ALLOWED_HOSTS`, `CORS_ALLOWED_ORIGINS`, and `CSRF_TRUSTED_ORIGINS`.

## License
Internal project. No public license specified.
